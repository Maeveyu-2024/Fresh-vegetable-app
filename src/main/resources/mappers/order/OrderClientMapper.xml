<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.woniu.dao.order.OrderClientDao">

    <resultMap type="cn.woniu.entity.order.OrderClient" id="OrderClientMap">
        <id property="id" column="id"/>
        <result property="no" column="no"/>
        <result property="clientId" column="client_id"/>
        <result property="orderTime" column="order_time"/>
        <result property="address" column="address"/>
        <result property="totalMoney" column="total_money"/>
        <result property="status" column="status"/>
        <result property="payTime" column="pay_time"/>
        <result property="receiveTime" column="receive_time"/>
        <result property="finishTime" column="finish_time"/>
        <result property="updateTime" column="update_time"/>
        <result property="clientName" column="client_name"/>
        <collection property="orderItemList" ofType="cn.woniu.entity.order.OrderItem">
            <id property="id" column="id"/>
            <result property="orderId" column="order_id"/>
            <result property="goodsId" column="goods_id"/>
            <result property="num" column="num"/>
            <result property="price" column="price"/>
            <result property="unit" column="unit"/>
            <result property="status" column="status"/>
            <result property="goodsName" column="name"/>
            <result property="goodsPrice" column="sale_price"/>
        </collection>
    </resultMap>
    <update id="updateOrderByOrderId">
        UPDATE order_client oc, order_item oi
        SET oc.status = 4, oi.status = 4
        WHERE oc.id = oi.order_id AND oc.id = #{id}
    </update>
    <update id="updataOrderAddress">
        UPDATE order_client SET address = #{address} WHERE id = #{id}
    </update>
    <update id="updateOrderMoney">
        UPDATE order_client SET total_money = #{totalMoney} WHERE id = #{id}
    </update>
    <update id="updateOrderItem">
        <foreach collection="orderItemList" item="orderItem" separator=";">
            UPDATE order_item SET num = #{orderItem.num}, price = #{orderItem.price} WHERE goods_id = #{orderItem.goodsId}
        </foreach>
    </update>

    <select id="queryAll" resultMap="OrderClientMap">
        SELECT
            oc.id,
            oc.no,
            oc.client_id,
            oc.order_time,
            oc.address,
            oc.total_money,
            oc.status,
            oc.pay_time,
            oc.receive_time,
            oc.finish_time,
            oc.update_time,
            oi.id,
            oi.goods_id,
            oi.num,
            oi.price,
            oi.status,
            g.name,
            g.sale_price,
            c.client_name
        FROM
            order_client oc
            LEFT JOIN order_item oi ON oc.id = oi.order_id
            LEFT JOIN goods g ON oi.goods_id = g.id
            LEFT JOIN client c ON oc.client_id = c.id
        WHERE oc.status IN (0,1,2,3)
        <if test="no != null and no != ''">
            AND oc.no like concat('%',#{no},'%')
        </if>
        <if test="clientName != null and clientName != ''">
            AND c.client_name like concat('%',#{clientName},'%')
        </if>
        <if test="status != null">
            AND oc.status = #{status}
        </if>
        <if test="selectTime != null and selectTime.size > 0">
            AND oc.pay_time BETWEEN #{selectTime[0]} AND #{selectTime[1]}
        </if>
    </select>

</mapper>
